<html>
    <head>
        <title>Breadcrumb test</title>
        <script type="text/javascript" src="jquery-1.3.2.min.js"></script>
        <script type="text/javascript">
if (typeof Object.create !== 'function') {
    Object.create = function (o) {
        function F() {}
        F.prototype = o;
        return new F();
    };
}

window.MBO = {}; // global namespace
// Call @fun@ with @element@ and @i@
//
// Ex.
//   var sum = 0;
//   MBO.each([1,2,3], function(el) { sum += el });
//   # sum === 6
//
// Asign @this@ to @caller@
MBO.each = function each(collection, fun) {
    var i;
    for (i = 0; i < collection.length; i++) {
        fun.apply(each.caller, [collection[i], i]);
    }
};
// Call @fun@ with @element@ and @i@ and take add returned value
// to result collection
//
// Returns new collection containing results from calling @fun@
//
// Ex.
//   MBO.map([1,2,3], function(el) { return el * 2 });
//   #=> [2,4,6]
//
// Asign @this@ to @caller@
MBO.map = function map(collection, fun) {
    var i, result;
    result = []
    for (i = 0; i < collection.length; i++) {
        result.push(fun.apply(map.caller, [collection[i], i]));
    }
    return result;
};
// Call @fun@ with @element@ and @i@ and take only those elements from
// original collection, which @fun@ returned truthly value for
//
// Returns colleciton with values not filtered by fun
//
// Ex.
//   MBO.grep([1,2,3], function(el) { return el >= 2 });
//   #=> [2,3]
//
// Asigns @this@ to @caller@
MBO.grep = function grep(collection, fun) {
    var i, result, tmp;
    result = [];
    for (i = 0; i < collection.length; i++) {
        if (fun.apply(grep.caller, [collection[i], i])) {
            result.push(collection[i]);
        }
    }
    return result;
};
// Call @fun@ with @result@, @element@ and @i@ and take returend value
// as next result,
//
// Returns last result returned from func
//
// Ex.
//   MBO.reduce([1,2,3], 0, function(sum, el) { return sum + el });
//   #=> 6
//
// Asigns @this@ to @caller@
MBO.reduce = function reduce(collection, initial, fun) {
    var i, result;
    result = initial;
    for (i = 0; i < collection.length; i++) {
        result = fun.apply(reduce.caller, [result, collection[i], i]);
    }
    return result;
};


MBO.breadcrumb = { // namespace for project
    mapOptions : function(optionsList, prefix) {
        var prefixRx, result, depth;
        prefixRx = new RegExp("^(?:" + prefix + ")*");
        result = MBO.map(optionsList, function(item) {
            return {
                depth: (prefixRx.exec(item.text)[0].length / prefix.length),
                value: item.value,
                text: item.text.replace(prefixRx, "")
            };
        });
        return result;
    },
    reduceToDag : function(items) {
        var stack, dag;
        stack = [];
        dag = {};
        dag[""] = {item: {depth: -1}, child_ids: []}; // root value
        stack.push(""); // guard value, poining to root with negative depth
        MBO.each(items, function(item) {
            if (item.value.length > 0) { // skip empty value ("")
                dag[item.value] = {item: item, child_ids: []};
                while (stack.length > 0 &&
                    dag[ stack[ stack.length-1 ] ].item.depth >= item.depth) {
                    stack.pop();
                }
                if (stack.length > 0) {
                    dag[ stack[ stack.length-1 ] ].child_ids.push(item.value);
                }
                stack.push(item.value);
            }
        });
        return dag;
    },
    getDag : function(rootElement, prefix) {
        return this.reduceToDag(this.mapOptions($(rootElement).find("option"), prefix));
    }
};

jQuery(function($) {
    // autorun
    MBO.breadcrumb.getDag($("select"), "-");
});
        </script>
        <style>

        </style>
    </head>
    <body>
        <select id="categories">
            <option value=""> </option>
            <option value="1">cat 1</option>
            <option value="1.1">- cat 1.1</option>
            <option value="1.2">- cat 1.2</option>
            <option value="1.3">- cat 1.3</option>
            <option value="1.3.1">-- cat 1.3.1</option>
            <option value="1.3.2">-- cat 1.3.2</option>
            <option value="1.4">- cat 1.4</option>
            <option value="2">cat 2</option>
            <option value="2.1">- cat 2.1</option>
            <option value="2.2">- cat 2.2</option>
            <option value="2.3">- cat 2.3</option>
            <option value="2,4">- cat 2.4</option>
            <option value="3">cat 3</option>
            <option value="4">cat 4</option>
            <option value="4">cat 4</option>
            <option value="4.1">- cat 4.1</option>
            <option value="4.1.1">-- cat 4.1.1</option>
            <option value="4.1.1.1">--- cat 4.1.1.1</option>
            <option value="4.1.1.1.1">---- cat 4.1.1.1.1</option>
            <option value="4.1.1.1.1.1">----- cat 4.1.1.1.1.1</option>
            <option value="4.1.1.1.1.1.1">------ cat 4.1.1.1.1.1.1</option>
            <option value="4.1.1.1.1.1.1.1">------- cat 4.1.1.1.1.1.1.1</option>
            <option value="4.1.1.1.1.1.1.1.1">-------- cat 4.1.1.1.1.1.1.1.1</option>
            <option value="4.1.1.1.1.1.1.1.1.1">--------- cat 4.1.1.1.1.1.1.1.1.1</option>
            <option value="4.1.1.1.1.1.1.1.1.1.1">---------- cat 4.1.1.1.1.1.1.1.1.1.1</option>
            <option value="4.1.1.1.1.1.1.1.1.1.1.1">----------- cat 4.1.1.1.1.1.1.1.1.1.1.1</option>
            <option value="5">cat 5</option>
        </select>
    </body>
</html>
